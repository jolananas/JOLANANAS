// üçç JOLANANAS - Sch√©ma Base de Donn√©es
// =====================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Note: Les mod√®les Session, Account, VerificationToken ont √©t√© supprim√©s
// La gestion des comptes clients est maintenant assur√©e par Shopify Customer Accounts
// Le mod√®le User est conserv√© uniquement pour la liaison locale avec shopifyCustomerId

// üë§ Utilisateurs (liaison locale uniquement - donn√©es principales dans Shopify)
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  name          String?
  password      String?   // D√©pr√©ci√© - les mots de passe sont g√©r√©s par Shopify
  avatar        String?
  image         String?   // Pour compatibilit√© NextAuth
  role          String    @default("CUSTOMER")
  shopifyCustomerId String? @unique // ID client Shopify (liaison principale)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("users")
}

// üõí Paniers persist√©s
model Cart {
  id              String      @id @default(cuid())
  shopifyCustomerId String?    // ID client Shopify (remplace userId)
  sessionId       String?     @unique
  shopifyCartId   String?     // ID du panier Shopify
  status          String      @default("ACTIVE")
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  expiresAt       DateTime?
  
  // Relations
  items           CartItem[]
  
  @@map("carts")
}

// üõçÔ∏è Articles de panier
model CartItem {
  id              String   @id @default(cuid())
  cartId          String
  productId       String   // ID Shopify
  variantId       String   // ID variant Shopify
  quantity        Int
  price           Decimal  // Prix au moment de l'ajout
  title           String
  variantTitle    String?
  imageUrl        String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  cart Cart @relation(fields: [cartId], references: [id], onDelete: Cascade)
  
  @@map("cart_items")
}

// üì¶ Commandes (cache local optionnel)
model Order {
  id              String     @id @default(cuid())
  shopifyCustomerId String?  // ID client Shopify (remplace userId, optionnel car cache)
  shopifyOrderId  String?    @unique
  status          String     @default("PENDING")
  total           Decimal
  currency        String     @default("EUR")
  shippingCost    Decimal    @default(0)
  taxAmount       Decimal    @default(0)
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  
  // Relations
  orderItems      OrderItem[]
  addresses       Address[]
  
  @@map("orders")
}

// üìã Articles de commande
model OrderItem {
  id           String @id @default(cuid())
  orderId      String
  productId    String
  variantId    String
  quantity     Int
  price        Decimal
  title        String
  variantTitle String?
  imageUrl     String?
  createdAt    DateTime @default(now())
  
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  @@map("order_items")
}

// üè† Adresses (uniquement pour cache des adresses li√©es aux commandes)
// Note: Les adresses g√©n√©rales sont g√©r√©es par Shopify Customer Accounts
model Address {
  id         String     @id @default(cuid())
  orderId    String?    // Seulement pour adresses li√©es aux commandes
  type       String     @default("SHIPPING")
  firstName  String
  lastName   String
  company    String?
  address1   String
  address2   String?
  city       String
  province   String?
  country    String
  zip        String
  phone      String?
  isDefault  Boolean    @default(false)
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  
  order Order? @relation(fields: [orderId], references: [id], onDelete: SetNull)
  
  @@map("addresses")
}

// ‚öôÔ∏è Pr√©f√©rences Utilisateur (optionnel - peut √™tre migr√© vers Metafields Shopify)
model UserPreferences {
  id                 String   @id @default(cuid())
  shopifyCustomerId  String?  @unique // ID client Shopify (remplace userId, optionnel pour migration)
  language           String   @default("fr")
  timezone           String   @default("Europe/Paris")
  emailNotifications Boolean  @default(true)
  orderNotifications Boolean  @default(true)
  marketingEmails    Boolean  @default(false)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  
  @@map("user_preferences")
}

// üìù Logs d'Activit√© Utilisateur (optionnel - pour logs personnalis√©s)
model ActivityLog {
  id             String   @id @default(cuid())
  shopifyCustomerId String // ID client Shopify (remplace userId)
  action         String   // "LOGIN", "LOGOUT", "PROFILE_UPDATE", "PASSWORD_CHANGE", etc.
  ipAddress      String?
  userAgent      String?
  metadata       String?  // JSON string pour donn√©es suppl√©mentaires
  createdAt      DateTime @default(now())
  
  @@map("activity_logs")
}

// üîî Webhooks Shopify
model WebhookEvent {
  id          String        @id @default(cuid())
  topic       String
  shopifyId   String        @unique
  status      String @default("PENDING")
  payload     String
  processedAt DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  @@map("webhook_events")
}

// üìä Cache produit Shopify
model ProductCache {
  id          String   @id @default(cuid())
  shopifyId   String   @unique
  handle      String
  title       String
  description String?
  vendor      String?
  productType String?
  tags        String?
  images      String     // Array des URLs d'images (JSON serialis√©)
  variants    String     // Array des variants (JSON serialis√©)
  priceRange  String     // Prix min/max (JSON serialis√©)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("product_cache")
}

// Enums remplac√©s par des strings pour la compatibilit√© SQLite
// UserRole: "CUSTOMER" | "ADMIN"
// CartStatus: "ACTIVE" | "Checkout" | "COMPLETED" | "ABANDONED"
// OrderStatus: "PENDING" | "PAID" | "PROCESSING" | "SHIPPED" | "DELIVERED" | "CANCELLED" | "REFUNDED"
// AddressType: "SHIPPING" | "BILLING"
// WebhookStatus: "PENDING" | "PROCESSED" | "FAILED"
